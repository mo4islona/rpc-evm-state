<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 860 500" font-family="Inter, -apple-system, system-ui, sans-serif" font-size="13">
  <defs>
    <marker id="arr" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#64748b"/>
    </marker>
    <marker id="arr-green" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#16a34a"/>
    </marker>
    <marker id="arr-orange" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#ea580c"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="860" height="500" rx="8" fill="#fafbfc"/>

  <!-- Title -->
  <text x="430" y="30" text-anchor="middle" font-size="16" font-weight="700" fill="#1e293b">run_pipeline() — Multi-Block Replay Pipeline</text>

  <!-- ─── SQD Portal (top-left cloud) ─── -->
  <rect x="14" y="50" width="172" height="68" rx="10" fill="#fff7ed" stroke="#fdba74" stroke-width="1.5"/>
  <text x="100" y="72" text-anchor="middle" font-size="11" font-weight="600" fill="#ea580c">SQD Portal</text>
  <text x="100" y="88" text-anchor="middle" font-size="9" fill="#9a3412">portal.sqd.dev/datasets/</text>
  <text x="100" y="102" text-anchor="middle" font-size="9" fill="#9a3412">{dataset}/stream</text>

  <!-- Arrow: SQD Portal → SqdFetcher -->
  <line x1="100" y1="118" x2="100" y2="134" stroke="#ea580c" stroke-width="1.3" marker-end="url(#arr-orange)"/>

  <!-- ─── SQD Fetcher ─── -->
  <rect x="14" y="138" width="172" height="58" rx="6" fill="#fff7ed" stroke="#fdba74" stroke-width="1.5"/>
  <text x="100" y="160" text-anchor="middle" font-size="11" font-weight="600" fill="#ea580c">SqdFetcher</text>
  <text x="100" y="177" text-anchor="middle" font-size="9" fill="#9a3412">stream_blocks(from, to)</text>
  <text x="100" y="190" text-anchor="middle" font-size="8" fill="#a8a29e">pagination + retry + zstd</text>

  <!-- Arrow: SqdFetcher → Block Stream -->
  <line x1="100" y1="196" x2="100" y2="212" stroke="#ea580c" stroke-width="1.3" marker-end="url(#arr-orange)"/>

  <!-- ─── Block Stream ─── -->
  <rect x="14" y="216" width="172" height="154" rx="6" fill="#eff6ff" stroke="#bfdbfe" stroke-width="1.5"/>
  <text x="100" y="236" text-anchor="middle" font-size="11" font-weight="600" fill="#1e40af">Block Stream</text>
  <text x="100" y="252" text-anchor="middle" font-size="9" fill="#64748b">Stream&lt;Item=Result&lt;Block,E&gt;&gt;</text>
  <line x1="30" y1="258" x2="170" y2="258" stroke="#bfdbfe" stroke-width="1"/>

  <rect x="30" y="266" width="140" height="22" rx="4" fill="#dbeafe" stroke="#93c5fd" stroke-width="1"/>
  <text x="100" y="281" text-anchor="middle" font-size="10" fill="#1e40af">Block 65000001</text>

  <rect x="30" y="292" width="140" height="22" rx="4" fill="#dbeafe" stroke="#93c5fd" stroke-width="1"/>
  <text x="100" y="307" text-anchor="middle" font-size="10" fill="#1e40af">Block 65000002</text>

  <rect x="30" y="318" width="140" height="22" rx="4" fill="#dbeafe" stroke="#93c5fd" stroke-width="1"/>
  <text x="100" y="333" text-anchor="middle" font-size="10" fill="#1e40af">Block 65000003</text>

  <rect x="30" y="344" width="140" height="22" rx="4" fill="#dbeafe" stroke="#93c5fd" stroke-width="1"/>
  <text x="100" y="359" text-anchor="middle" font-size="10" fill="#1e40af">Block 65000004</text>

  <!-- Arrow: Stream → Pipeline -->
  <line x1="186" y1="293" x2="218" y2="293" stroke="#64748b" stroke-width="1.5" marker-end="url(#arr)"/>

  <!-- ─── Pipeline core (center) ─── -->
  <rect x="225" y="115" width="400" height="310" rx="8" fill="#f0fdf4" stroke="#86efac" stroke-width="1.5"/>
  <text x="425" y="136" text-anchor="middle" font-size="12" font-weight="600" fill="#166534">Pipeline Loop</text>

  <!-- Resume check -->
  <rect x="245" y="150" width="360" height="42" rx="5" fill="#fff7ed" stroke="#fed7aa" stroke-width="1"/>
  <text x="265" y="168" font-size="11" font-weight="600" fill="#9a3412">Resume check</text>
  <text x="265" y="183" font-size="10" fill="#78350f">if block.number ≤ head_block → skip</text>

  <!-- Gap detection -->
  <rect x="245" y="200" width="360" height="42" rx="5" fill="#fef2f2" stroke="#fecaca" stroke-width="1"/>
  <text x="265" y="218" font-size="11" font-weight="600" fill="#991b1b">Gap detection</text>
  <text x="265" y="233" font-size="10" fill="#991b1b">if block.number ≠ last + 1 → Error::Source</text>

  <!-- replay_block -->
  <rect x="245" y="252" width="360" height="50" rx="5" fill="#eef2ff" stroke="#a5b4fc" stroke-width="1.5"/>
  <text x="425" y="273" text-anchor="middle" font-size="12" font-weight="600" fill="#3730a3">replay_block(db, block, chain_spec)</text>
  <text x="425" y="291" text-anchor="middle" font-size="10" fill="#6366f1">execute txs → flush to StateDb atomically</text>

  <!-- Progress callback -->
  <rect x="245" y="312" width="360" height="50" rx="5" fill="#faf5ff" stroke="#d8b4fe" stroke-width="1"/>
  <text x="265" y="331" font-size="11" font-weight="600" fill="#7c3aed">on_progress(BlockProgress)</text>
  <text x="265" y="348" font-size="10" fill="#6b21a8">block_number, tx_count, blocks_processed, elapsed</text>

  <!-- Loop arrow (return false) -->
  <rect x="245" y="370" width="360" height="38" rx="5" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/>
  <text x="425" y="394" text-anchor="middle" font-size="11" fill="#475569">callback returns <tspan font-weight="600" fill="#16a34a">true</tspan> → next block  |  <tspan font-weight="600" fill="#dc2626">false</tspan> → stop</text>

  <!-- Loop-back arrow on the left side -->
  <path d="M240,395 L225,395 L225,155 L240,155" fill="none" stroke="#16a34a" stroke-width="1.5" marker-end="url(#arr-green)"/>
  <text x="218" y="275" text-anchor="middle" font-size="9" fill="#16a34a" transform="rotate(-90, 218, 275)">next block</text>

  <!-- ─── StateDb (bottom) ─── -->
  <rect x="265" y="443" width="310" height="45" rx="6" fill="#eef2ff" stroke="#a5b4fc" stroke-width="1.5"/>
  <text x="420" y="464" text-anchor="middle" font-size="12" font-weight="600" fill="#3730a3">StateDb  (RocksDB)</text>
  <text x="420" y="480" text-anchor="middle" font-size="10" fill="#6366f1">head_block updated after each block commit</text>

  <!-- Arrow: replay_block → StateDb -->
  <line x1="425" y1="425" x2="425" y2="440" stroke="#64748b" stroke-width="1.5" marker-end="url(#arr)"/>

  <!-- ─── Output (right) ─── -->
  <rect x="650" y="115" width="190" height="160" rx="6" fill="#f0fdf4" stroke="#86efac" stroke-width="1.5"/>
  <text x="745" y="136" text-anchor="middle" font-size="12" font-weight="600" fill="#166534">PipelineStats</text>
  <line x1="666" y1="144" x2="824" y2="144" stroke="#86efac" stroke-width="1"/>
  <text x="666" y="164" font-size="11" fill="#475569">blocks_processed: 4</text>
  <text x="666" y="182" font-size="11" fill="#475569">first_block: 65000001</text>
  <text x="666" y="200" font-size="11" fill="#475569">last_block: 65000004</text>
  <text x="666" y="218" font-size="11" fill="#475569">elapsed: 2.4s</text>
  <text x="666" y="236" font-size="11" fill="#475569">blocks_per_sec: 1.67</text>
  <text x="666" y="264" font-size="10" fill="#64748b">returned after stream ends</text>
  <text x="666" y="278" font-size="10" fill="#64748b">or callback returns false</text>

  <!-- Arrow: Pipeline → Output -->
  <line x1="625" y1="195" x2="647" y2="195" stroke="#64748b" stroke-width="1.5" marker-end="url(#arr)"/>

  <!-- ─── Safety callout (bottom right) ─── -->
  <rect x="650" y="320" width="190" height="100" rx="5" fill="#fff7ed" stroke="#fed7aa" stroke-width="1"/>
  <text x="660" y="340" font-size="10" font-weight="600" fill="#9a3412">Safety guarantees:</text>
  <text x="660" y="358" font-size="10" fill="#78350f">&#8226; Each block is atomic</text>
  <text x="660" y="373" font-size="10" fill="#78350f">&#8226; Safe to drop between blocks</text>
  <text x="660" y="388" font-size="10" fill="#78350f">&#8226; Resume from head_block</text>
  <text x="660" y="403" font-size="10" fill="#78350f">&#8226; Consecutive blocks required</text>

  <!-- ─── Data flow label ─── -->
  <text x="100" y="410" text-anchor="middle" font-size="9" fill="#94a3b8">Generic over any Stream source.</text>
  <text x="100" y="422" text-anchor="middle" font-size="9" fill="#94a3b8">SqdFetcher is the typical producer.</text>
</svg>
